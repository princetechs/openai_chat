<%# This template will be rendered when a message is created via Turbo Streams %>
<% @chat.messages.where(role: [Message::ROLE_USER, Message::ROLE_ASSISTANT]).order(:created_at).last(2).each do |message| %>
  <%= turbo_stream.append "messages" do %>
    <div class="message mb-3 <%= message.role == Message::ROLE_USER ? 'user-message' : 'assistant-message' %>">
      <div class="message-content p-3 rounded <%= message.role == Message::ROLE_USER ? 'bg-primary text-white ms-auto' : 'bg-light' %>" 
           style="max-width: 80%; <%= message.role == Message::ROLE_USER ? 'margin-left: auto;' : '' %>">
        <div class="message-header mb-1 d-flex align-items-center">
          <strong><%= message.role == Message::ROLE_USER ? 'You' : 'Assistant' %></strong>
          <small class="ms-2 text-<%= message.role == Message::ROLE_USER ? 'light' : 'muted' %>">
            <%= message.created_at.strftime("%H:%M") %>
          </small>
        </div>
        <div class="message-body">
          <%= simple_format(message.content) %>
        </div>
      </div>
    </div>
  <% end %>
<% end %>

<%= turbo_stream.replace "new-message-form" do %>
  <%= form_with(model: [@chat, Message.new], local: false, class: "chat-form", id: "new-message-form") do |form| %>
    <div class="input-group">
      <%= form.text_area :content, class: "form-control", placeholder: "Type your message here...", rows: 2, required: true, autofocus: true %>
      <button type="submit" class="btn btn-primary">
        <i class="bi bi-send"></i> Send
      </button>
    </div>
  <% end %>
<% end %>

<script>
  // Scroll to the bottom of the messages container
  const messagesContainer = document.getElementById('messages');
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
  
  // Focus the message input field
  document.querySelector('#new-message-form textarea').focus();
  
  // Auto-resize textarea as user types
  const textarea = document.querySelector('#new-message-form textarea');
  textarea.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
  });
</script>

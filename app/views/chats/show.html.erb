<% content_for :title, @page_title %>

<div class="d-flex align-items-center mb-4">
  <h1 class="me-auto"><%= @chat.title %></h1>
  <div>
    <%= link_to chats_path, class: "btn btn-outline-secondary me-2" do %>
      <i class="bi bi-arrow-left"></i> All Chats
    <% end %>
    <%= link_to edit_chat_path(@chat), class: "btn btn-outline-primary" do %>
      <i class="bi bi-pencil"></i> Edit
    <% end %>
  </div>
</div>

<div class="card shadow">
  <div class="card-header bg-light py-3">
    <div class="d-flex align-items-center">
      <div class="me-auto">
        <strong><i class="bi bi-chat-dots"></i> Conversation with OpenAI</strong>
      </div>
      <small class="text-muted">Started <%= time_ago_in_words(@chat.created_at) %> ago</small>
    </div>
  </div>
  <div class="card-body">
    <div id="messages" class="chat-messages mb-4" style="height: 60vh; overflow-y: auto;">
      <% if @messages.empty? %>
        <div class="text-center text-muted my-5">
          <i class="bi bi-chat-dots" style="font-size: 3rem;"></i>
          <p class="mt-3">No messages yet. Start the conversation!</p>
        </div>
      <% else %>
        <% @messages.each do |message| %>
          <div class="message mb-3 <%= message.role == Message::ROLE_USER ? 'user-message' : 'assistant-message' %>">
            <div class="message-content p-3 rounded <%= message.role == Message::ROLE_USER ? 'bg-primary text-white ms-auto' : 'bg-light' %>" 
                 style="max-width: 80%; <%= message.role == Message::ROLE_USER ? 'margin-left: auto;' : '' %>">
              <div class="message-header mb-1 d-flex align-items-center">
                <strong><%= message.role == Message::ROLE_USER ? 'You' : 'Assistant' %></strong>
                <small class="ms-2 text-<%= message.role == Message::ROLE_USER ? 'light' : 'muted' %>">
                  <%= message.created_at.strftime("%H:%M") %>
                </small>
              </div>
              <div class="message-body">
                <%= simple_format(message.content) %>
              </div>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>

    <%= form_with(model: [@chat, @message], local: false, class: "chat-form", id: "new-message-form") do |form| %>
      <div class="input-group">
        <%= form.text_area :content, class: "form-control", placeholder: "Type your message here...", rows: 2, required: true, autofocus: true %>
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-send"></i> Send
        </button>
      </div>
    <% end %>
  </div>
</div>

<script>
  // Scroll to the bottom of the messages container when the page loads
  document.addEventListener('DOMContentLoaded', function() {
    const messagesContainer = document.getElementById('messages');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    // Focus the message input field
    document.querySelector('#new-message-form textarea').focus();
    
    // Auto-resize textarea as user types
    const textarea = document.querySelector('#new-message-form textarea');
    textarea.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
    });
  });
</script>
